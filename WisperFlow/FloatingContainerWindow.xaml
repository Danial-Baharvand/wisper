<Window x:Class="WisperFlow.FloatingContainerWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:wv2="clr-namespace:Microsoft.Web.WebView2.Wpf;assembly=Microsoft.Web.WebView2.Wpf"
        Title="WisperFlow Browser"
        Width="600" Height="700"
        MinWidth="400" MinHeight="400"
        WindowStyle="None"
        AllowsTransparency="True"
        Background="Transparent"
        Topmost="True"
        ShowInTaskbar="False"
        ResizeMode="NoResize"
        WindowStartupLocation="Manual">
    
    <Window.Resources>
        <!-- Fade in animation -->
        <Storyboard x:Key="FadeInAnimation">
            <DoubleAnimation Storyboard.TargetProperty="Opacity"
                           From="0" To="1" Duration="0:0:0.25">
                <DoubleAnimation.EasingFunction>
                    <CubicEase EasingMode="EaseOut"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
            <DoubleAnimation Storyboard.TargetName="ContentTransform" Storyboard.TargetProperty="Y"
                           From="20" To="0" Duration="0:0:0.3">
                <DoubleAnimation.EasingFunction>
                    <CubicEase EasingMode="EaseOut"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
        </Storyboard>
        
        <!-- Fade out animation -->
        <Storyboard x:Key="FadeOutAnimation">
            <DoubleAnimation Storyboard.TargetProperty="Opacity"
                           To="0" Duration="0:0:0.2">
                <DoubleAnimation.EasingFunction>
                    <CubicEase EasingMode="EaseIn"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
            <DoubleAnimation Storyboard.TargetName="ContentTransform" Storyboard.TargetProperty="Y"
                           To="20" Duration="0:0:0.2">
                <DoubleAnimation.EasingFunction>
                    <CubicEase EasingMode="EaseIn"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
        </Storyboard>
        
        <!-- Transcript expand animation -->
        <Storyboard x:Key="TranscriptExpandAnimation">
            <DoubleAnimation Storyboard.TargetName="TranscriptBorder" Storyboard.TargetProperty="Opacity"
                           From="0" To="1" Duration="0:0:0.3">
                <DoubleAnimation.EasingFunction>
                    <CubicEase EasingMode="EaseOut"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
        </Storyboard>
        
        <!-- Cursor blink animation -->
        <Storyboard x:Key="CursorBlinkAnimation" RepeatBehavior="Forever">
            <DoubleAnimation Storyboard.TargetName="TypingCursor"
                           Storyboard.TargetProperty="Opacity"
                           From="1" To="0" Duration="0:0:0.5"
                           AutoReverse="True"/>
        </Storyboard>
        
        <!-- Floating button style -->
        <Style x:Key="FloatingButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="#E6121820"/>
            <Setter Property="Foreground" Value="#8892b0"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Width" Value="36"/>
            <Setter Property="Height" Value="36"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" 
                                CornerRadius="18" Padding="8">
                            <Border.Effect>
                                <DropShadowEffect Color="Black" BlurRadius="8" Opacity="0.4" ShadowDepth="2"/>
                            </Border.Effect>
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#2a2a3e"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#3a3a4e"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>
    
    <!-- Main container - uses Canvas for absolute positioning of floating button -->
    <Grid>
        <!-- Main content stack -->
        <Grid x:Name="MainContentGrid">
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            
            <!-- Browser section with rounded corners -->
            <Border x:Name="BrowserBorder" 
                    Grid.Row="0"
                    Background="#F8121820" 
                    CornerRadius="16" 
                    BorderBrush="#2a2a3e"
                    BorderThickness="1"
                    ClipToBounds="True"
                    Margin="0,0,0,0">
                <Border.RenderTransform>
                    <TranslateTransform x:Name="ContentTransform" Y="0"/>
                </Border.RenderTransform>
                <Border.Effect>
                    <DropShadowEffect Color="Black" BlurRadius="20" Opacity="0.5" ShadowDepth="2"/>
                </Border.Effect>
                
                <Grid>
                    <!-- WebView2 browsers -->
                    <Grid ClipToBounds="True">
                        <!-- Clip for rounded bottom corners -->
                        <Grid.Clip>
                            <RectangleGeometry x:Name="BrowserClipGeometry"/>
                        </Grid.Clip>
                        
                        <!-- ChatGPT WebView -->
                        <wv2:WebView2 x:Name="ChatGPTWebView"
                                      DefaultBackgroundColor="Transparent"
                                      Visibility="Visible"/>
                        <!-- Gemini WebView -->
                        <wv2:WebView2 x:Name="GeminiWebView"
                                      DefaultBackgroundColor="Transparent"
                                      Visibility="Collapsed"/>
                    </Grid>
                    
                    <!-- Drag area (invisible, covers top of browser for dragging) -->
                    <Border x:Name="DragArea" 
                            Height="40" 
                            VerticalAlignment="Top" 
                            Background="Transparent"
                            Cursor="SizeAll"
                            MouseLeftButtonDown="DragArea_MouseLeftButtonDown"/>
                    
                    <!-- Resize handles (invisible) -->
                    <!-- Top-left corner -->
                    <Rectangle x:Name="ResizeTopLeft" Width="16" Height="16" 
                               Fill="Transparent" Cursor="SizeNWSE"
                               HorizontalAlignment="Left" VerticalAlignment="Top"
                               MouseLeftButtonDown="ResizeHandle_MouseLeftButtonDown"/>
                    <!-- Top-right corner -->
                    <Rectangle x:Name="ResizeTopRight" Width="16" Height="16" 
                               Fill="Transparent" Cursor="SizeNESW"
                               HorizontalAlignment="Right" VerticalAlignment="Top"
                               MouseLeftButtonDown="ResizeHandle_MouseLeftButtonDown"/>
                    <!-- Bottom-left corner -->
                    <Rectangle x:Name="ResizeBottomLeft" Width="16" Height="16" 
                               Fill="Transparent" Cursor="SizeNESW"
                               HorizontalAlignment="Left" VerticalAlignment="Bottom"
                               MouseLeftButtonDown="ResizeHandle_MouseLeftButtonDown"/>
                    <!-- Bottom-right corner -->
                    <Rectangle x:Name="ResizeBottomRight" Width="16" Height="16" 
                               Fill="Transparent" Cursor="SizeNWSE"
                               HorizontalAlignment="Right" VerticalAlignment="Bottom"
                               MouseLeftButtonDown="ResizeHandle_MouseLeftButtonDown"/>
                    
                    <!-- Loading indicator overlay -->
                    <Border x:Name="LoadingOverlay" 
                            Background="#80121820" 
                            Visibility="Collapsed">
                        <TextBlock Text="Loading..." 
                                   Foreground="#8892b0" 
                                   FontFamily="Segoe UI" 
                                   FontSize="14"
                                   HorizontalAlignment="Center" 
                                   VerticalAlignment="Center"/>
                    </Border>
                </Grid>
            </Border>
            
            <!-- Transcript section (appears below browser when dictating) -->
            <Border x:Name="TranscriptBorder" 
                    Grid.Row="1"
                    Background="#F0121820" 
                    CornerRadius="16" 
                    Padding="20,16"
                    Margin="0,8,0,0"
                    Opacity="0"
                    Visibility="Collapsed">
                <Border.Effect>
                    <DropShadowEffect Color="Black" BlurRadius="20" Opacity="0.5" ShadowDepth="2"/>
                </Border.Effect>
                
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    
                    <!-- Header with status indicator -->
                    <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,8">
                        <Ellipse x:Name="LiveDot" Width="8" Height="8" Fill="#00d4aa" Margin="0,0,8,0" VerticalAlignment="Center"/>
                        <TextBlock x:Name="StatusText" Text="Listening..." 
                                   Foreground="#64ffda" FontFamily="Segoe UI" FontSize="11" FontWeight="Medium"
                                   VerticalAlignment="Center" Opacity="0.8"/>
                    </StackPanel>
                    
                    <!-- Transcript text area -->
                    <ScrollViewer x:Name="TranscriptScroller" 
                                  Grid.Row="1"
                                  VerticalScrollBarVisibility="Hidden" 
                                  HorizontalScrollBarVisibility="Disabled"
                                  MaxHeight="150">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock x:Name="TranscriptText" 
                                       Text="" 
                                       Foreground="#e6f1ff" 
                                       FontFamily="Cascadia Code, Consolas, Segoe UI" 
                                       FontSize="15" 
                                       FontWeight="Normal"
                                       TextWrapping="Wrap"
                                       LineHeight="22"
                                       VerticalAlignment="Top"/>
                            <!-- Animated typing cursor -->
                            <Border x:Name="TypingCursor" 
                                    Width="2" Height="18" 
                                    Background="#64ffda" 
                                    VerticalAlignment="Top"
                                    Margin="1,2,0,0"
                                    CornerRadius="1"
                                    Visibility="Collapsed"/>
                        </StackPanel>
                    </ScrollViewer>
                </Grid>
            </Border>
        </Grid>
        
        <!-- Floating "Open in Browser" button - positioned outside bottom-right -->
        <Button x:Name="OpenExternalButton"
                Style="{StaticResource FloatingButtonStyle}"
                ToolTip="Open in default browser"
                Click="OpenExternalButton_Click"
                HorizontalAlignment="Right"
                VerticalAlignment="Bottom"
                Margin="0,0,-20,20">
            <TextBlock Text="â†—" FontSize="16" Foreground="#8892b0"/>
        </Button>
    </Grid>
</Window>
